"use client"

import type React from "react"
import { useState, useEffect } from "react"
import {
  IonContent,
  IonHeader,
  IonPage,
  IonTitle,
  IonToolbar,
  IonCard,
  IonCardHeader,
  IonCardSubtitle,
  IonCardTitle,
  IonCardContent,
  IonIcon,
  IonGrid,
  IonRow,
  IonCol,
  IonButton,
  IonButtons,
  IonMenuButton,
  IonAvatar,
  IonItem,
  IonLabel,
  IonBadge,
  IonList,
  IonListHeader,
  IonText,
  IonChip,
  IonSpinner,
  IonAlert,
} from "@ionic/react"
import {
  peopleOutline,
  businessOutline,
  calendarOutline,
  documentTextOutline,
  schoolOutline,
  statsChartOutline,
  logOutOutline,
  alertCircleOutline,
  checkmarkCircleOutline,
  hourglassOutline,
  listOutline,
  shieldOutline,
  addOutline,
  eyeOutline,
  refreshOutline,
} from "ionicons/icons"
import { useHistory } from "react-router"
import { useAudit } from "../hooks/useAudit"
import { useRole } from "../contexts/RoleContext"
import AuthService from "../services/AuthService"
import leaveService from "../services/LeaveService"
import EmployeeService from "../services/EmployeeService"

const HRDashboard: React.FC = () => {
  const history = useHistory()
  const { logEvent } = useAudit()
  const { userRole, employee, loading, hasPermission } = useRole()
  const [pendingRequests, setPendingRequests] = useState(0)
  const [myRequests, setMyRequests] = useState(0)
  const [approvedRequests, setApprovedRequests] = useState(0)
  const [rejectedRequests, setRejectedRequests] = useState(0)
  const [leaveBalance, setLeaveBalance] = useState(0)
  const [totalLeaveCredits, setTotalLeaveCredits] = useState(0)
  const [usedLeaveCredits, setUsedLeaveCredits] = useState(0)
  const [dashboardLoading, setDashboardLoading] = useState(true)
  const [showLogoutAlert, setShowLogoutAlert] = useState(false)
  const [currentUser, setCurrentUser] = useState<any>(null)
  const [currentEmployee, setCurrentEmployee] = useState<any>(null)
  const [currentRole, setCurrentRole] = useState<any>(null)
  const [fetchingEmployeeData, setFetchingEmployeeData] = useState(false)

  // Helper function to get current authenticated user
  const getCurrentAuthUser = () => {
    if (currentUser) return currentUser
    
    try {
      const storedAuthUser = localStorage.getItem('authUser')
      if (storedAuthUser) {
        return JSON.parse(storedAuthUser)
      }
    } catch (error) {
      console.error('Error parsing stored auth user:', error)
    }
    return null
  }

  // Fetch employee data from backend using authenticated user ID
  const fetchEmployeeFromBackend = async (authUserId: string) => {
    try {
      setFetchingEmployeeData(true)
      console.log('Fetching employee data for auth user ID:', authUserId)
      
      const employeeData = await EmployeeService.getEmployeeByAuthId(authUserId)
      if (employeeData) {
        console.log('Fetched employee from backend:', employeeData)
        setCurrentEmployee(employeeData)
        
        // Determine role based on employee data
        const role = determineEmployeeRole(employeeData)
        setCurrentRole(role)
        
        return employeeData
      } else {
        console.warn('No employee found for auth user ID:', authUserId)
        return null
      }
    } catch (error) {
      console.error('Error fetching employee from backend:', error)
      return null
    } finally {
      setFetchingEmployeeData(false)
    }
  }

  // Determine employee role based on employee data
  const determineEmployeeRole = (employeeData: any) => {
    if (!employeeData) return null

    // Extract role information from employee data
    const position = employeeData.position_title || ''
    const roleLevel = employeeData.role_level || 99

    // Define role based on position and level
    const roleMapping: { [key: number]: any } = {
      0: { // VPAA
        level: 0,
        title: 'Vice President for Academic Affairs',
        canApprove: true,
        approvalScope: 'all',
        permissions: {
          viewAllRequests: true,
          approveRequests: true,
          manageLeaveCredits: true,
          manageLeavePolicies: true,
          viewReports: true,
          manageEmployees: true
        }
      },
      1: { // Dean
        level: 1,
        title: 'Dean',
        canApprove: true,
        approvalScope: 'department',
        permissions: {
          viewAllRequests: true,
          approveRequests: true,
          manageLeaveCredits: true,
          manageLeavePolicies: false,
          viewReports: true,
          manageEmployees: false
        }
      },
      2: { // Program Chair
        level: 2,
        title: 'Program Chair',
        canApprove: true,
        approvalScope: 'program',
        permissions: {
          viewAllRequests: false,
          approveRequests: true,
          manageLeaveCredits: false,
          manageLeavePolicies: false,
          viewReports: true,
          manageEmployees: false
        }
      },
      3: { // Regular Faculty
        level: 3,
        title: 'Regular Faculty',
        canApprove: false,
        approvalScope: 'none',
        permissions: {
          viewAllRequests: false,
          approveRequests: false,
          manageLeaveCredits: false,
          manageLeavePolicies: false,
          viewReports: false,
          manageEmployees: false
        }
      },
      4: { // Part-Time Faculty
        level: 4,
        title: 'Part-Time Faculty',
        canApprove: false,
        approvalScope: 'none',
        permissions: {
          viewAllRequests: false,
          approveRequests: false,
          manageLeaveCredits: false,
          manageLeavePolicies: false,
          viewReports: false,
          manageEmployees: false
        }
      },
      5: { // Secretary
        level: 5,
        title: 'Secretary',
        canApprove: false,
        approvalScope: 'none',
        permissions: {
          viewAllRequests: false,
          approveRequests: false,
          manageLeaveCredits: false,
          manageLeavePolicies: false,
          viewReports: false,
          manageEmployees: false
        }
      }
    }

    return roleMapping[roleLevel] || {
      level: 99,
      title: 'Employee',
      canApprove: false,
      approvalScope: 'none',
      permissions: {
        viewAllRequests: false,
        approveRequests: false,
        manageLeaveCredits: false,
        manageLeavePolicies: false,
        viewReports: false,
        manageEmployees: false
      }
    }
  }

  // Helper function to check if user has permission
  const hasCurrentPermission = (permission: string): boolean => {
    return currentRole?.permissions?.[permission] || false
  }
  // Initialize authenticated user from localStorage on component mount
  useEffect(() => {
    const initializeAuthUser = async () => {
      try {
        const storedAuthUser = localStorage.getItem('authUser')
        if (storedAuthUser) {
          const authUser = JSON.parse(storedAuthUser)
          setCurrentUser(authUser)
          console.log('Initialized auth user:', authUser)
          
          // Fetch employee data from backend using auth user ID
          if (authUser.uid && authUser.isAuthenticated) {
            await fetchEmployeeFromBackend(authUser.uid)
          }
        }
      } catch (error) {
        console.error('Error parsing stored auth user:', error)
      }
    }

    initializeAuthUser()
  }, [])
  useEffect(() => {
    if (currentUser && currentEmployee && currentRole) {
      loadDashboardData()
    }
  }, [currentUser, currentEmployee, currentRole])
  
  const loadDashboardData = async () => {
    try {
      setDashboardLoading(true)
      
      // Ensure we have current user data
      let authUser = getCurrentAuthUser()
      if (authUser) {
        setCurrentUser(authUser)
      }
      
      if (!authUser || !authUser.isAuthenticated) {
        console.warn('No authenticated user found')
        return
      }

      if (!currentEmployee) {
        console.warn('No employee data found')
        return
      }
      
      console.log('Loading dashboard data for employee:', currentEmployee.firstName, currentEmployee.lastName)
      
      // Load user's own leave requests with detailed breakdown
      const myRequestsData = await leaveService.getMyLeaveRequests()
      setMyRequests(myRequestsData.length)
      
      // Count requests by status
      const approved = myRequestsData.filter(req => req.status === 'Approved').length
      const rejected = myRequestsData.filter(req => req.status === 'Rejected').length
      setApprovedRequests(approved)
      setRejectedRequests(rejected)

      // Load leave credits for detailed balance information
      const creditsData = await leaveService.getMyLeaveCredits()
      let totalCredits = 0
      let usedCredits = 0
      let remainingBalance = 0
      
      creditsData.forEach(credit => {
        totalCredits += credit.total_credits || 0
        usedCredits += credit.used_credits || 0
        remainingBalance += credit.remaining_credits || 0
      })
      
      setTotalLeaveCredits(totalCredits)
      setUsedLeaveCredits(usedCredits)
      setLeaveBalance(remainingBalance)

      // For approvers, get pending requests count
      if (currentRole?.canApprove) {
        try {
          const approvalsData = await leaveService.getPendingApprovalsForMe()
          setPendingRequests(approvalsData.requests?.length || 0)
        } catch (error) {
          console.error('Error loading pending approvals:', error)
          setPendingRequests(0)
        }
      }
    } catch (error) {
      console.error('Error loading dashboard data:', error)
      // Set default values on error
      setMyRequests(0)
      setApprovedRequests(0)
      setRejectedRequests(0)
      setLeaveBalance(0)
      setTotalLeaveCredits(0)
      setUsedLeaveCredits(0)      setPendingRequests(0)
    } finally {
      setDashboardLoading(false)
    }
  }
  
  const handleLogout = async () => {
    try {
      // Get current user for logging
      const authUser = getCurrentAuthUser()
      
      // Log the logout event
      logEvent(
        authUser?.uid?.toString() || 'unknown',
        authUser?.displayName || authUser?.email || (currentEmployee?.firstName + ' ' + currentEmployee?.lastName) || 'Unknown User',
        'Logout',
        'Authentication',
        'User logged out',
        '127.0.0.1',
        'success'
      )
      
      await AuthService.signOut()
      
      // Clear local state
      setCurrentUser(null)
      setCurrentEmployee(null)
      setCurrentRole(null)
      
      history.push('/sign-in')
    } catch (error) {
      console.error('Logout error:', error)
    }
  }

  // Refresh dashboard data by re-fetching from backend
  const refreshDashboard = async () => {
    const authUser = getCurrentAuthUser()
    if (authUser?.uid && authUser.isAuthenticated) {
      await fetchEmployeeFromBackend(authUser.uid)
      // loadDashboardData will be called automatically via useEffect
    }
  }
  }
    const navigateTo = (path: string, moduleName: string) => {
    // Get current user for logging
    const authUser = getCurrentAuthUser()
    
    // Log the navigation event
    logEvent(
      authUser?.uid?.toString() || currentEmployee?.id || 'unknown',
      authUser?.displayName || currentEmployee?.firstName + ' ' + currentEmployee?.lastName || 'Unknown User',
      'View',
      moduleName as any,
      `Navigated to ${moduleName} module`,
      '127.0.0.1',
      'success'
    )

    // Navigate to the page
    history.push(path)
  }
  // Define role-based modules that should be visible
  const getAvailableModules = () => {
    const modules = []

    // Core modules available to everyone
    modules.push({
      title: "My Leave Requests",
      icon: calendarOutline,
      path: "/leave-request",
      color: "primary"
    })

    // Role-based modules
    if (hasCurrentPermission('approveRequests')) {
      modules.push({
        title: "Leave Approval",
        icon: documentTextOutline,
        path: "/leave-approval",
        color: "success"
      })
    }

    if (hasCurrentPermission('viewReports')) {
      modules.push({
        title: "Reports",
        icon: statsChartOutline,
        path: "/reports",
        color: "tertiary"
      })
    }

    if (hasCurrentPermission('manageEmployees')) {
      modules.push({
        title: "Employee Directory",
        icon: peopleOutline,
        path: "/employee-directory",
        color: "primary"
      })

      modules.push({
        title: "Organization",
        icon: businessOutline,
        path: "/organization-management",
        color: "primary"
      })
    }

    if (hasCurrentPermission('manageLeavePolicies')) {
      modules.push({
        title: "Leave Policies",
        icon: listOutline,
        path: "/leave-policy-management",
        color: "secondary"
      })
    }

    // Faculty Loading - available to certain roles
    if (currentRole?.level !== undefined && currentRole.level <= 2) {
      modules.push({
        title: "Faculty Loading",
        icon: schoolOutline,
        path: "/faculty-loading",
        color: "primary"
      })
    }

    // Audit Trail - available to admins
    if (hasCurrentPermission('viewReports')) {
      modules.push({
        title: "Audit Trail",
        icon: shieldOutline,
        path: "/audit-trail",
        color: "dark"
      })
    }

    return modules
  }
  if (loading || fetchingEmployeeData || (!currentUser && !currentEmployee)) {
    return (
      <IonPage>
        <IonContent className="ion-padding ion-text-center">
          <div style={{ marginTop: '50%' }}>
            <IonSpinner name="crescent" color="primary" />
            <IonText>
              <p>Loading dashboard...</p>
              <p style={{ fontSize: '14px', color: 'gray' }}>
                Initializing user session...
              </p>
            </IonText>
          </div>
        </IonContent>
      </IonPage>
    )
  }
  return (
    <IonPage>      <IonHeader>
        <IonToolbar>
          <IonButtons slot="start">
            <IonMenuButton />
          </IonButtons>          <IonTitle>
            {currentRole?.title === 'System Administrator' ? 'HR Dashboard' : 'Dashboard'}
          </IonTitle>
          <IonButtons slot="end">            <IonButton 
              fill="clear" 
              onClick={loadDashboardData}
              disabled={dashboardLoading}
            >
              {dashboardLoading ? (
                <IonSpinner name="crescent" />
              ) : (
                <IonIcon slot="icon-only" icon={refreshOutline} />
              )}
            </IonButton>
            <IonButton onClick={() => setShowLogoutAlert(true)}>
              <IonIcon slot="icon-only" icon={logOutOutline} />
            </IonButton>
          </IonButtons>
        </IonToolbar>
      </IonHeader>
      <IonContent className="ion-padding">        {/* User Welcome Card */}
        <IonCard className="ion-margin-bottom">
          <IonCardContent>
            <IonGrid>
              <IonRow className="ion-align-items-center">                <IonCol size="auto">
                  <IonAvatar>
                    <img 
                      src={currentEmployee?.profileImage || "/placeholder.svg"} 
                      alt="User avatar" 
                    />
                  </IonAvatar>
                </IonCol>
                <IonCol>
                  <IonText color="dark">
                    <h2 className="ion-no-margin">
                      Welcome, {currentUser?.displayName || (currentEmployee?.firstName + ' ' + currentEmployee?.lastName) || 'User'}
                    </h2>
                  </IonText>
                  <IonText color="medium">
                    <p className="ion-no-margin">{currentEmployee?.position_title || currentRole?.title || 'Employee'}</p>
                    <p className="ion-no-margin">{currentEmployee?.department_name || 'Department'}</p>
                    <p className="ion-no-margin">ID: {currentEmployee?.employeeId || currentUser?.uid || 'N/A'}</p>
                  </IonText>
                </IonCol>
                <IonCol size="auto">
                  <IonChip color={currentUser?.isAuthenticated ? "success" : "danger"}>
                    <IonLabel>
                      {currentUser?.isAuthenticated ? 'Active' : 'Inactive'}
                    </IonLabel>
                  </IonChip>
                </IonCol>
              </IonRow>
            </IonGrid>
          </IonCardContent>
        </IonCard>{/* Quick Action Cards */}
        <IonGrid>
          <IonRow>
            <IonCol size="12" sizeMd="6" sizeLg="3">
              <IonCard 
                button 
                onClick={() => navigateTo("/leave-request", "Leave Request")}
                className="ion-text-center"
              >
                <IonCardHeader>
                  <IonIcon icon={addOutline} color="primary" style={{ fontSize: "32px" }} />
                  <IonCardTitle>New Request</IonCardTitle>
                  <IonCardSubtitle>Create Leave Request</IonCardSubtitle>
                </IonCardHeader>
              </IonCard>
            </IonCol>
            <IonCol size="12" sizeMd="6" sizeLg="3">
              <IonCard 
                button 
                onClick={() => navigateTo("/leave-request", "Leave Request")}
                className="ion-text-center"
              >
                <IonCardHeader>
                  <IonIcon icon={calendarOutline} color="secondary" style={{ fontSize: "32px" }} />
                  <IonCardTitle>{dashboardLoading ? '...' : myRequests}</IonCardTitle>
                  <IonCardSubtitle>My Total Requests</IonCardSubtitle>
                </IonCardHeader>
              </IonCard>
            </IonCol>
            <IonCol size="12" sizeMd="6" sizeLg="3">
              <IonCard className="ion-text-center">
                <IonCardHeader>
                  <IonIcon icon={checkmarkCircleOutline} color="success" style={{ fontSize: "32px" }} />
                  <IonCardTitle>{dashboardLoading ? '...' : leaveBalance}</IonCardTitle>
                  <IonCardSubtitle>Remaining Credits</IonCardSubtitle>
                </IonCardHeader>
              </IonCard>
            </IonCol>
            {userRole?.canApprove && (
              <IonCol size="12" sizeMd="6" sizeLg="3">
                <IonCard 
                  button 
                  onClick={() => navigateTo("/leave-approval", "Leave Approval")}
                  className="ion-text-center"
                >
                  <IonCardHeader>
                    <IonIcon icon={hourglassOutline} color="warning" style={{ fontSize: "32px" }} />
                    <IonCardTitle>{dashboardLoading ? '...' : pendingRequests}</IonCardTitle>
                    <IonCardSubtitle>Pending Approvals</IonCardSubtitle>
                  </IonCardHeader>
                </IonCard>
              </IonCol>
            )}
          </IonRow>
          
          {/* Additional Statistics Row */}
          <IonRow>
            <IonCol size="12" sizeMd="4">
              <IonCard className="ion-text-center">
                <IonCardHeader>
                  <IonIcon icon={checkmarkCircleOutline} color="success" style={{ fontSize: "24px" }} />
                  <IonCardTitle>{dashboardLoading ? '...' : approvedRequests}</IonCardTitle>
                  <IonCardSubtitle>Approved Requests</IonCardSubtitle>
                </IonCardHeader>
              </IonCard>
            </IonCol>
            <IonCol size="12" sizeMd="4">
              <IonCard className="ion-text-center">
                <IonCardHeader>
                  <IonIcon icon={alertCircleOutline} color="danger" style={{ fontSize: "24px" }} />
                  <IonCardTitle>{dashboardLoading ? '...' : rejectedRequests}</IonCardTitle>
                  <IonCardSubtitle>Rejected Requests</IonCardSubtitle>
                </IonCardHeader>
              </IonCard>
            </IonCol>
            <IonCol size="12" sizeMd="4">
              <IonCard className="ion-text-center">
                <IonCardHeader>
                  <IonIcon icon={statsChartOutline} color="tertiary" style={{ fontSize: "24px" }} />
                  <IonCardTitle>{dashboardLoading ? '...' : `${usedLeaveCredits}/${totalLeaveCredits}`}</IonCardTitle>
                  <IonCardSubtitle>Used/Total Credits</IonCardSubtitle>
                </IonCardHeader>
              </IonCard>
            </IonCol>
          </IonRow>
        </IonGrid>

        {/* Available Modules */}
        <IonGrid>
          <IonRow>
            <IonCol size="12">
              <IonListHeader>
                <IonLabel>Available Modules</IonLabel>
              </IonListHeader>
            </IonCol>
          </IonRow>
          <IonRow>
            {getAvailableModules().map((module, index) => (
              <IonCol key={index} size="6" sizeMd="4" sizeLg="3">
                <IonCard button onClick={() => navigateTo(module.path, module.title)}>
                  <IonCardContent className="ion-text-center ion-padding">
                    <IonIcon 
                      icon={module.icon} 
                      color={module.color} 
                      style={{ fontSize: "32px" }} 
                    />
                    <IonText>
                      <h3 className="ion-no-margin ion-margin-top">{module.title}</h3>
                    </IonText>
                  </IonCardContent>
                </IonCard>
              </IonCol>
            ))}
          </IonRow>
        </IonGrid>        {/* Employee Information Card */}
        <IonCard className="ion-margin-top">
          <IonCardHeader>
            <IonCardTitle>Employee Information</IonCardTitle>
          </IonCardHeader>
          <IonCardContent>
            <IonList lines="none">
              <IonItem>
                <IonLabel>
                  <h3>Employee ID</h3>
                  <p>{employee?.employee_id || 'Not assigned'}</p>
                </IonLabel>
              </IonItem>
              <IonItem>
                <IonLabel>
                  <h3>Full Name</h3>
                  <p>{currentUser?.displayName || employee?.full_name || 'Not specified'}</p>
                </IonLabel>
              </IonItem>
              <IonItem>
                <IonLabel>
                  <h3>Email</h3>
                  <p>{currentUser?.email || employee?.email || 'Not specified'}</p>
                </IonLabel>
              </IonItem>
              <IonItem>
                <IonLabel>
                  <h3>Position</h3>
                  <p>{employee?.position_title || 'Not specified'}</p>
                </IonLabel>
              </IonItem>
              <IonItem>
                <IonLabel>
                  <h3>Department</h3>
                  <p>{employee?.department_name || 'Not specified'}</p>
                </IonLabel>
              </IonItem>
              <IonItem>
                <IonLabel>
                  <h3>Office</h3>
                  <p>{employee?.office_name || 'Not specified'}</p>
                </IonLabel>
              </IonItem>
              <IonItem>
                <IonLabel>
                  <h3>Approval Authority</h3>
                  <p>{userRole?.canApprove ? `Can approve ${userRole.approvalScope} requests` : 'No approval authority'}</p>
                </IonLabel>
              </IonItem>
              <IonItem>
                <IonLabel>
                  <h3>Permissions</h3>
                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px', marginTop: '8px' }}>
                    {Object.entries(userRole?.permissions || {}).map(([permission, hasAccess]) => (
                      hasAccess && (
                        <IonChip key={permission} color="primary">
                          <IonLabel style={{ fontSize: '12px' }}>
                            {permission.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}
                          </IonLabel>
                        </IonChip>
                      )
                    ))}
                  </div>
                </IonLabel>
              </IonItem>
            </IonList>
          </IonCardContent>
        </IonCard>

        {/* Logout Confirmation Alert */}
        <IonAlert
          isOpen={showLogoutAlert}
          onDidDismiss={() => setShowLogoutAlert(false)}
          header={'Confirm Logout'}
          message={'Are you sure you want to logout?'}
          buttons={[
            {
              text: 'Cancel',
              role: 'cancel',
              cssClass: 'secondary'
            },
            {
              text: 'Logout',
              handler: handleLogout
            }
          ]}
        />
      </IonContent>
    </IonPage>
  )
}

export default HRDashboard
